<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>{$book['title']}</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<meta content="black" name="apple-mobile-web-app-status-bar-style" />
		<meta content="telephone=no" name="format-detection" />
		<link rel="stylesheet" type="text/css" href="__MODULE_CSS__/base.css" />
		<link rel="stylesheet" type="text/css" href="__MODULE_CSS__/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="__MODULE_CSS__/read.css" />
		<script src="__MODULE_JS__/fontSize.js"></script>
		<link rel="stylesheet" href="__MODULE_CSS__/weui.min.css">
	</head>
	<style type="text/css">
		.vip{
			background: url(__MODULE_IMG__/img-png/zhao.png)no-repeat center center;
			background-size: 100% 100%;
		}
		.tubiao{
			background: url(__MODULE_IMG__/img-png/detail_tag_left.png)no-repeat left top;
			background-size: 0.61rem 0.61rem;
		}

		.duosongtu{
			background: url(__MODULE_IMG__/img-png/detail_tag_right.png)no-repeat right top;
			background-size: 0.61rem 0.61rem;
		}
		.huodongtu{
			background: url(__MODULE_IMG__/img-png/detail_tag_right.png)no-repeat right top;
			background-size: 0.61rem 0.61rem;
		}
		.baoniantu{
			background: url(__MODULE_IMG__/img-png/detail_tag_left.png)no-repeat left top;
			background-size: 0.61rem 0.61rem;
		}
		.mui-toast-message{
			margin-bottom:3.7rem;
				padding:0.4rem 0.4rem;
		}
		.zhidao{
			width: 100%;
			height:100%;
			position: fixed;
			left:0;
			top:0;
			z-index: 999;
			background-color: rgba(0,0,0,.7);
			display: none;
			text-align: right;
		}
		.zhidao_pic{
			width: 6.75rem;
			height:4.30rem;
		}
		.vip_tro{
			margin-left: 0!important;
		}
		.MVIP{
			z-index:999!important;
		}
		#mock {
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,.5);
			position: fixed;
			z-index: 100;
			display: none;
			left: 0;
			top: 0;
		}
		.link_hua{
			width: 100%;
			height: 0.6rem;
			padding:0.3rem 0;
		}
		.link_hua:after{
			content: '';
			display: block;
			clear: both;
		}
		.link_s{
			width: 50%;
			height:0.6rem;
			line-height: 0.6rem;
			text-align: center;
		}
		.link_s>a{
			display: block;
			width: 100%;
			height:100%;
			font-size: 0.26rem;
		}
		.link_s>a>span{
			color: #333;
		}
		.link_s>a>img{
			width: 0.28rem;
			height: 0.28rem;
			margin: 0 0.1rem 0.05rem;
		}
		.vipRecharge_content {
			width: 6.16rem;
			padding-bottom: 0.7rem;
			margin: 0rem auto 0;
			background-color: #fff;
			border-radius: 0.15rem;
			position: relative;
			top: -2.5rem;
		}
		/*.index_body {*/
			/*overflow: hidden;*/
			/*height: 100%;*/
			/*position: relative;*/
		/*}*/
	</style>
	<body>
	<header id="header">
		<div class="header_return">
			<a href="{:url('document/desc',['bid'=>$document['bid'],'comefrom'=>5])}"><img src="__MODULE_IMG__/img-png/fanhui.png" alt="" /></a>
		</div>
		<div class="header_content"><span>{$document['title']}</span></div>
		<div class="header_home">
			<a href="{:url('index/index')}"><img src="__MODULE_IMG__/img-png/shouye-.png" /></a>
		</div>
	</header>
	<input type="hidden" name="idx" id="idx" value="{$document.idx}">
	<input type="hidden" name="bid" id="bid" value="{$document.bid}">
	<input type="hidden" name="bid" id="isvip" value="{$document.isvip}">
		<section id="section">
			<div>
				<ul class="cartoon" id="cartoon">
					{volist name="document.content" id="vo"}
					<li class="cartoon_list">
						<img src="{$vo}" alt="">
					</li>
					{/volist}
				</ul>

				<input type="hidden" class="xstype" value="{$book['xstype']}" />

				<div class="link_hua">
					{if $isgz['showFollowPopupOnNext'] == "false"}
					<div class="fl link_s" style="border-right: 1px solid #ddd;">
						{if ($isgz['zindex'] > 1)}
						<a href="{$prev.url}{if !empty($tgid)}?t={$tgid}&f={$f}{/if}">
							<img src="__MODULE_IMG__/img-png/jiantour.png" alt="">
							<span>上一话</span>
						</a>
						{else}
						<a href="javascript:mui.toast('没有上一话了');">
							<img src="__MODULE_IMG__/img-png/jiantour.png" alt="">
							<span>上一话</span>
						</a>
						{/if}
					</div>
					<div class="fl link_s next">
						<a id="url" href="{$next.url}?updateReadHistory=true{if !empty($tgid)}&t={$tgid}&f={$f}{/if}">
							<span>下一话</span>
							<img src="__MODULE_IMG__/img-png/jiantoul.png" alt="">
						</a>
					</div>
					{/if}
				</div>
				<div style="width: 100%;height: 0.5rem;"></div>
			</div>

			<input type="hidden" class="xstype" value="{$book['xstype']}" />
		</section>
	<footer id="footer">
		{if $isgz['showFollowPopupOnNext'] == "false"}
		<div class="footer_send">
			{if ($isgz['zindex'] > 1)}
			<a href="{$prev.url}{if !empty($tgid)}?t={$tgid}&f={$f}{/if}"><span class="read_share">上一话</span></a>
			{else}
			<a href="javascript:mui.toast('没有上一话了');"><span class="read_share">上一话</span></a>
			{/if}
		</div>
		{/if}
		<div class="footer_shou">
			<a href="javascript:void(0);"><!--<img src="__MODULE_IMG__/img-png/jiarushujia.png" />-->
				<span>
					{if condition="$is_collect gt 0"}
					已收藏
					{else /}
					收藏本书
					{/if}
				</span>
			</a>
		</div>
		<div class="footer_mu">

			<a href="{:url('cms/Column/indexidx',['bid' => $document['bid']])}"><span>目录</span></a>
		</div>
		{if $isgz['showFollowPopupOnNext'] == "false"}
		<div class="footer_send">
			<a class="url" href="{$next.url}?updateReadHistory=true{if !empty($tgid)}&t={$tgid}&f={$f}{/if}"><span class="read_share">下一话</span></a>
		</div>
		{/if}
	</footer>
		<!--遮罩层-->
		<div id="mock"></div>
	<!--vip充值-->

	<div class="weui_panel weui_panel_access {if empty($zpay)}tag-panel{/if} MVIP" style="position:fixed;display:none;top:0%;width:100%;height:100%;margin:0px;padding:0px;background: rgba(0,0,0,0.5);">
		<div class="inner-opt buy vip" id="tag" style="font-size: 16px;background-color: none">
			<div class="vip_content">
			<div class="vip_one"><img src="__MODULE_IMG__/img-png/zhiche.png" alt="" /></div>
			<!--  如果不能全本购买 -->
			<div class="weui_btn_area pl7 vip_two" style="padding-left:7px;line-height: 24px">
				本章价格：<span class="vip_tro vip_sbi" style='color:#FF5448'>{$shubi}</span> 书币<br />
			<span class="vip_tro vip_all" style='color:#FF5448'>账户余额：<span style='color:#FF5448' id="coin">{:moneyToCoin($usercoin)}</span> 书币</span> ( 1元=100书币 )
			</div>
			<p class="weui_btn_area vip_three" style="margin-top:10px">
			充值并解锁
			</p>
			<div style="font-size:12px">
				<div class="vip_four" style="font-size:12px;color:#D6A464;padding:6px 15px;padding-bottom:0px">
					<p><span class="vip_tro_bold" style="text-align: right;color:#000">提示：</span>1.如充值未到账，请确认当前账号与充值账号是否一致</p>
					<p class="vip_indent" style="color:#999">2.如有问题请联系客服，客服微信号：huotun666</p>
				</div>
			</div>
			</div>
		</div>
	</div>


	<div class="vipRecharge">
		<div class="vipRecharge_content">
			<div class="vipRecharge_one">
				<div class="vr_close">
					<img src="__MODULE_IMG__/img-png/close.png" alt="" />
				</div>
				<p class="vipRecharge_choose">请选择充值金额</p>
				<p class="vipRecharge_huan">(1元=100书币)</p>
			</div>
			<div class="vipRecharge_main vipShow">
				{volist name="pro" id="vo"}
				<div class="vipRecharge_list">
					<a href="javascript:void(0);"   class="tubiao  {if empty($noselect)}
                                     {if $k==1} active{/if}
                                  {else /}
                                    {if $vo.status==1} active{/if}
                                  {/if}" data-pid="{$vo.id}" data-welth="{$vo.score}">
						<div class="vr_top">
							<span class="vip_tiyan">{$vo.offer_title}</span>
							<p class="vr_top_cz">充值</p>
							<p class="vr_top_jiner">¥{$vo.titilea}</p>
						</div>
						<div class="vr_btm">
							<p class="vr_btm_duo">{$vo.titileb}</p>
							<p class="vr_btm_song">{$vo.titilec}</p>
						</div>
					</a>
				</div>
				{/volist}
			</div>
			<div class="vipRecharge_two">
				确认充值
			</div>
		</div>

	</div>


	</body>
	<script src="__MODULE_JS__/mui.js"></script>
	<script src="__MODULE_JS__/jquery-1.8.3.min.js"></script>
	<script src="__MODULE_JS__/jquery-weui.js"></script>
	<script type="text/javascript">
        var bid= $("#bid").val();
        var idx= $("#idx").val();
        var isvip= $("#isvip").val();
        var apiurl = '/index.php/cms/document/detail';
        var cursor = 4;
        var loading = false;
        var limit = 4;
        var completed = false;

        $(document.body).infinite(500).on('infinite', function () {
            if (loading || completed || isvip == 1) {
                return false;
            }

            loadList(cursor);
        });

        function loadList(start) {
            loading = true;
            return $.get(apiurl, {bid:bid ,start: start, limit: limit,idx:idx}, function (ret) {
                $.each(ret, function (index,item) {
                    $('.cartoon').append(
                        '<li class="cartoon_list">\n' +
                        '<img src="'+item+'" alt="">\n' +
                        '</li>'
                    );
                });
                var len = 0;
                if(ret){
                    len = ret.length
                }
                cursor = cursor + len;
                completed = len === 0;
                loading = false;
                if (completed) {
                    $(document.body).destroyInfinite();
//                    $('.comment_content').append('<div class="list">已加载完毕</div>');
                }

            });

        }

		$(".next,.footer_send").click(function () {

            if($("#url").attr('href').indexOf('/index.php/cms/index/index.html') != -1||$(".url").attr('href').indexOf('/index.php/cms/index/index.html') != -1){
                mui.toast('当前已是最后一话');
                $('.weui_toast').css({'width': 'auto', 'padding': '0px 5px'})
                return false;
            }
        })


        $("#section").on("click",".cartoon_list", function() {

			$("#header").animate({
				top: "0",
				opacity: "1"
			}, 200);
			$("#footer").animate({
				bottom: "0",
				opacity: "1"
			}, 200);
			$("#mock").show();
			//$('body').addClass('index_body');
		});
		$("#mock").click(function(){
			$("#header").animate({
				top: "-0.8rem",
				opacity: "0"
			}, 200);
			$("#footer").animate({
				bottom: "-0.93rem",
				opacity: "0"
			}, 200);
			$("#mock").hide();
            //$('body').removeClass('index_body');
		})


        {notempty name="$zpay"}
            $(".MVIP").attr('style','display:block');
		{/notempty}

		//去掉一开始选择全部的条件
			$('.vipShow').find(".tubiao").removeClass('vip_active');
            $('.vipShow').find(".vr_btm").removeClass('vip_bor_active');
            $('.vipShow').find(".tubiao").eq(0).addClass('vip_active');
            $('.vipShow').find(".vr_btm").eq(0).addClass('vip_bor_active');

        // 收藏
        var index=0; // 收藏
        var stat=1; //数量
        $('.footer_shou>a').on('click', function(){
            $.post("/index.php/cms/document/operate",{bid:'{$book.id}',num:stat,type:index,collect:'collect'},function(data){
                mui.toast(data.msg,{ duration:'long', type:'div' });
//                $.toast(data.msg);
                $('.footer_shou>a>span').html('已收藏');
            })

        })

        //充值页面内容
        //弹出充值金币的选择
        $(".vip_three").click(function(){
			$('.vipRecharge').show();
        })

//		$(".vip").on('click',".vip_three",function () {
//            $('.vipRecharge').show();
//        })
        //关闭充值金币的选择
        $(".vr_close").click(function(){
            $('.vipRecharge').hide();
        })
        //监听选择的内容
        $(".vipRecharge_main").on("click",".vipRecharge_list>a",function(){
            $(".vipRecharge_list>a").removeClass("vip_active");
            $(this).addClass('vip_active');
            $(".vr_btm").removeClass('vip_bor_active');
            $(this).find('.vr_btm').addClass('vip_bor_active');
        })
            $(function () {
                var cid = '{$chapterId}';
                var packsell = '{$book["packsell"]}';

                function jsApiCall(json){
                    WeixinJSBridge.invoke(
                        'getBrandWCPayRequest',
                        json,
                        function(res){
                            //WeixinJSBridge.log(res.err_msg);
                            //alert(res.err_code+res.err_desc+res.err_msg);
                            if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                                //alert('支付成功。');
                                var url = '/index.php/cms/pay/index.html?bid={$bookid}&cid={$chapterId}';
                                if(cid != '' && cid > 0){
                                    url = '/index.php/cms/document/detail/id/' + cid;
                                }
                                    location.href = url;
                            }else{
                                //alert(res.errMsg);
                                if(res.err_msg == "get_brand_wcpay_request:cancel"){

                                    mui.alert("支付已取消","提示","确定",function () {
                                        window.location.reload();
                                    });
                                    //window.history.go(-1);
                                }else{

                                    mui.alert("支付失败，请重新选择进行支付","支付失败","确定",function () {
                                        window.location.reload();
                                    });
                                    //window.history.go(-1);
                                }
                            }
                        }
                    );
                }

                function callpay(json) {
                    if (typeof WeixinJSBridge == "undefined") {
                        if (document.addEventListener) {
                            document.addEventListener('WeixinJSBridgeReady', jsApiCall(json), false);
                        } else if (document.attachEvent) {
                            document.attachEvent('WeixinJSBridgeReady', jsApiCall(json));
                            document.attachEvent('onWeixinJSBridgeReady', jsApiCall(json));
                        }
                    } else {
                        jsApiCall(json);
                    }
                }

                var articleId = null;
                var returnUrl = '';
                var tradeType = '';
                var submitting = false;
                $('#products-grid .product-item').click(function () {
                    $('#products-grid .product-item').removeClass('active');
                    $(this).addClass('active');
                });
                $('.vipRecharge_two').on('click', function () {
                    if (submitting) {
                        return false;
                    }
                    submitting = true;
                    var chooseVal = $(".vip_active").attr('data-pid');
//                    alert(chooseVal);

//                     定义支付请求链接
                    var url = "/index.php/cms/pay/pay.html?id=" + chooseVal + "&bid=" + "{$bookid}";

                    if (articleId) {
                        url += '&aid=' + articleId;
                    }
                    if (tradeType) {
                        url += '&trade_type=' + tradeType;
                    }
                    if (returnUrl) {
                        url += '&return=' + encodeURIComponent(returnUrl);
                    }
                    if ({$zffs} == 1) {
						$(".vipRecharge").hide()
                        $.post(url, {}, function (resu) {
                            var jsonObj = JSON.parse(resu);
                            callpay(jsonObj);
                        })
                    }


                    // var productId = $('#products-grid .product-item.active').data('pid');
                    // var url = '/index.php/cms/pay/duobaopay/payprodcutid/'+productId+'/bid/{$book.id}';
                    // if (articleId) {
                    //     url += '&aid=' + articleId;
                    // }
                    // if (tradeType) {
                    //     url += '&trade_type=' + tradeType;
                    // }
                    // if (returnUrl) {
                    //     url += '&return=' + encodeURIComponent(returnUrl);
                    // }
                    // if ({$zffs}==1) {
                    // var llpay = '/index.php/cms/pay/duobaopay/';
                    // $.ajax({
                    //     url: '/index.php/cms/pay/savellpayid/',
                    //     type: 'POST',
                    //     dataType: 'JSON',
                    //     contentType: 'application/json',
                    //     data: JSON.stringify({
                    //         id: productId,
                    //     })
                    // })
                    // .then(function (payload) {
                    //     location.href = llpay;
                    // })
                    // .fail(function (error) {
                    //     window.location.reload();
                    // });
                    // }
                    // if ({$zffs}==1) {
                    // location.href = url;
                    // }
                    return false;
                })
            })
            {notempty name="$zpay"}
            $(".MVIP").attr('style','display:block');
            {/notempty}

        var LoadMore = function () {
            mui('#section').pullRefresh().endPulldownToRefresh(true);
            mui('#section').pullRefresh().setStopped(true);//暂时禁止滚动
            mui.toast('已经是第一章了哦~', {duration: 'long', type: 'div'});
            mui('#section').pullRefresh().setStopped(false);//开启禁止滚动
        }
	</script>

</html>